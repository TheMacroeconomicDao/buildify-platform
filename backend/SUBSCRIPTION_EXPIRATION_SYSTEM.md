# Система управления истечением подписок

## Обзор

Реализована система автоматического управления истечением подписок с уведомлениями для пользователей и администраторов.

## Новые поля в таблице users

- `subscription_started_at` - дата начала текущей подписки
- `subscription_ends_at` - дата окончания текущей подписки (NULL для бесплатных тарифов)

## Новые методы в модели User

### `hasActiveSubscription(): bool`
Проверяет, активна ли подписка пользователя:
- Бесплатные тарифы (Free, price = 0) всегда активны
- Платные тарифы проверяются по дате окончания

### `activateSubscription(Tariff $tariff): void`
Активирует подписку на указанный тариф:
- Устанавливает дату начала (сейчас)
- Для платных тарифов рассчитывает дату окончания
- Для бесплатных тарифов дата окончания = NULL

### `getDaysUntilSubscriptionExpires(): ?int`
Возвращает количество дней до истечения подписки:
- NULL для бесплатных/бессрочных подписок
- Отрицательное число для просроченных подписок

## Автоматическая команда проверки

### `subscriptions:check-expired`

Команда выполняется автоматически каждый час и:

1. **Находит истекшие подписки**
   - Пользователи с `subscription_ends_at <= now()`
   - Переводит их на бесплатный тариф
   - Отправляет уведомления

2. **Предупреждает о скором истечении**
   - За 3 дня до истечения
   - Создает уведомления для администраторов

### Типы уведомлений

- `subscription_expired` - подписка истекла
- `subscription_expiring` - подписка истекает через 3 дня

## Обновленные API ответы

### GET `/api/subscriptions/my`

Теперь возвращает дополнительную информацию:

```json
{
  "success": true,
  "subscription": null,
  "tariff": {...},
  "subscription_started_at": "2025-08-15T10:00:00.000000Z",
  "subscription_ends_at": "2025-09-15T10:00:00.000000Z",
  "is_active": true,
  "days_until_expiration": 30
}
```

## Логика активации после оплаты

1. **Бесплатные тарифы**: активируются сразу без даты окончания
2. **Платные тарифы**: активируются через Stripe webhook с датой окончания
3. **После успешной оплаты**: пользователь получает полный доступ к функциям тарифа

## Настройка cron

Для работы автоматической проверки добавьте в crontab:

```bash
* * * * * cd /path/to/project && php artisan schedule:run >> /dev/null 2>&1
```

## Мониторинг

- Команда логирует все действия
- Создает уведомления для администраторов
- Можно запускать вручную для тестирования: `php artisan subscriptions:check-expired`
