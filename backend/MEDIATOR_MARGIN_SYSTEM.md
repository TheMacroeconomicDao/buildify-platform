# Система управления маржей посредников

## Обзор

Система позволяет администраторам вручную настраивать маржи и договорные цены для посредников в админ-панели.

## Типы настроек маржи

### 1. Процентная маржа
- Поле: `mediator_margin_percentage`
- Тип: decimal(5,2) - до 999.99%
- Описание: Процент от суммы заказа

### 2. Фиксированная комиссия
- Поле: `mediator_fixed_fee`
- Тип: decimal(10,2) - до 99,999,999.99 AED
- Описание: Фиксированная сумма за каждый заказ

### 3. Договорная цена
- Поле: `mediator_agreed_price`
- Тип: decimal(10,2) - до 99,999,999.99 AED
- Описание: Индивидуально договоренная цена

### 4. Заметки
- Поле: `mediator_notes`
- Тип: text
- Описание: Внутренние заметки об условиях работы

## Приоритет расчета комиссии

1. **Договорная цена** - наивысший приоритет
2. **Фиксированная комиссия** - средний приоритет
3. **Процентная маржа** - низший приоритет

## Использование в админ-панели

### Создание посредника
1. Перейти в "Посредники" → "Добавить"
2. Заполнить основную информацию
3. Сохранить

### Настройка маржи
1. Открыть существующего посредника
2. В разделе "Настройки маржи и цен" указать:
   - Процент маржи (если нужен процентный расчет)
   - Фиксированную комиссию (если нужна фиксированная сумма)
   - Договорную цену (если есть индивидуальная договоренность)
   - Заметки по договоренности
3. Сохранить

### Просмотр списка посредников
В списке посредников отображается колонка "Маржа" с информацией о настроенных условиях:
- "10.5%" - процентная маржа
- "500 AED" - фиксированная комиссия
- "Договор: 1000 AED" - договорная цена
- "Не настроено" - если маржа не задана

## API методы

### GET /api/mediators
Получить список активных посредников

### GET /api/mediators/{id}
Получить информацию о конкретном посреднике

### POST /api/mediators/calculate-commission
Рассчитать комиссию посредника для заказа
```json
{
  "mediator_id": 123,
  "order_amount": 1000.00
}
```

## Методы модели User

### getMediatorMarginInfo()
Возвращает массив с настроенными параметрами маржи

### calculateMediatorCommission(float $orderAmount)
Рассчитывает комиссию посредника для указанной суммы заказа

## Примеры использования

### Пример 1: Процентная маржа 15%
- Сумма заказа: 1000 AED
- Комиссия: 150 AED

### Пример 2: Фиксированная комиссия 200 AED
- Сумма заказа: 1000 AED
- Комиссия: 200 AED

### Пример 3: Договорная цена 500 AED
- Сумма заказа: 1000 AED
- Комиссия: 500 AED (независимо от суммы заказа)

### Пример 4: Комбинированные настройки
Если у посредника настроено:
- Процентная маржа: 10%
- Фиксированная комиссия: 300 AED
- Договорная цена: 800 AED

То будет использоваться договорная цена 800 AED (наивысший приоритет).

## Безопасность

- Все поля маржи доступны только администраторам
- Данные о марже не передаются в мобильное приложение
- Расчеты производятся только на сервере
