# Асинхронная генерация изображений дизайна

## Проблема

Ранее генерация изображений с помощью DALL-E происходила синхронно в контроллере, что приводило к блокировке всего бэкенда на 30-60 секунд для других пользователей. Это создавало плохой пользовательский опыт и ограничивало масштабируемость системы.

## Решение

Реализована система асинхронной генерации изображений с использованием Laravel Queues и WebSocket уведомлений.

### Архитектура решения

1. **Немедленный возврат дизайна** - контроллер сразу возвращает сгенерированный дизайн без изображений
2. **Асинхронная генерация изображений** - изображения генерируются в фоновой задаче (Job)
3. **Отслеживание прогресса** - специальная модель для отслеживания статуса генерации
4. **WebSocket уведомления** - клиент получает уведомление о готовности изображений
5. **API для получения статуса** - возможность проверить статус и получить готовые изображения

### Компоненты системы

#### 1. GenerateDesignImagesJob
Фоновая задача для генерации изображений:
- Таймаут: 5 минут
- Попытки повтора: 2
- Обработка ошибок с сохранением в БД
- WebSocket уведомления о завершении

#### 2. DesignImageGeneration Model
Модель для отслеживания задач генерации:
- Уникальный ID генерации
- Статусы: pending, processing, completed, failed
- Сохранение результатов и ошибок
- Связь с пользователем

#### 3. DesignImagesGeneratedEvent
WebSocket событие для уведомления клиента:
- Приватный канал для пользователя
- Передача готовых изображений или ошибки
- Timestamp завершения

#### 4. DesignImageGenerationController
API контроллер для работы с генерацией:
- Получение статуса генерации
- Получение готовых изображений
- Список генераций пользователя

### API Endpoints

#### GET /api/design/images/status/{generationId}
Получить статус генерации изображений
```json
{
  "success": true,
  "generation_id": "uuid",
  "status": "completed|pending|processing|failed",
  "images": [...],
  "error_message": null,
  "created_at": "2025-01-01T00:00:00Z",
  "completed_at": "2025-01-01T00:01:30Z"
}
```

#### GET /api/design/images/get/{generationId}
Получить готовые изображения
```json
{
  "success": true,
  "generation_id": "uuid",
  "images": [
    {
      "url": "https://...",
      "prompt": "...",
      "index": 1
    }
  ],
  "completed_at": "2025-01-01T00:01:30Z"
}
```

#### GET /api/design/images/my-generations
Список генераций пользователя (требует авторизации)
```json
{
  "success": true,
  "generations": [
    {
      "generation_id": "uuid",
      "status": "completed",
      "description": "Modern living room...",
      "images_count": 2,
      "created_at": "2025-01-01T00:00:00Z",
      "completed_at": "2025-01-01T00:01:30Z"
    }
  ]
}
```

### WebSocket Events

#### Канал: `user.{userId}`
#### Событие: `design.images.generated`
```json
{
  "generation_id": "uuid",
  "images": [...],
  "error": null,
  "status": "completed|failed",
  "timestamp": "2025-01-01T00:01:30Z"
}
```

### Изменения в существующих компонентах

#### ChatGPTDesignService
- Добавлен параметр `userId` в `generateInteriorDesign()`
- Метод `generateDesignImages()` стал публичным для использования в Job
- Добавлен метод `startAsyncImageGeneration()` для запуска фоновой задачи

#### DesignGenerationController
- Уменьшен таймаут с 2 минут до 1 минуты
- Передача `userId` в сервис
- Возврат `generation_id` для отслеживания

### Настройка очередей

#### Конфигурация
- По умолчанию используется database queue
- Настроен Laravel worker в supervisord.conf
- Таймауты и retry настроены для стабильной работы

#### Запуск worker'а
```bash
php artisan queue:work --sleep=3 --tries=3 --max-time=3600
```

### Миграция базы данных

Создана таблица `design_image_generations`:
- `generation_id` - уникальный UUID
- `user_id` - связь с пользователем
- `design_content` - контент дизайна для генерации
- `description`, `room_type`, `style` - параметры генерации
- `status` - текущий статус
- `images` - результат генерации (JSON)
- `error_message` - сообщение об ошибке
- `started_at`, `completed_at` - временные метки

### Преимущества нового решения

1. **Неблокирующая архитектура** - бэкенд не блокируется во время генерации изображений
2. **Лучший UX** - пользователь сразу получает дизайн и может работать с ним
3. **Масштабируемость** - можно обрабатывать множество запросов параллельно
4. **Отказоустойчивость** - ошибки генерации не влияют на основной функционал
5. **Прозрачность** - пользователь видит прогресс генерации
6. **Повторные попытки** - автоматический retry при временных ошибках

### Мониторинг и логирование

- Все этапы генерации логируются
- Ошибки сохраняются в БД и логах
- WebSocket события для real-time уведомлений
- API для проверки статуса и истории генераций

### Совместимость

Изменения обратно совместимы:
- Существующий API продолжает работать
- Добавлено поле `generation_id` в ответ
- Поле `images` теперь пустое в основном ответе
- Клиенты могут использовать новые endpoints по желанию
